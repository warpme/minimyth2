From cb6543defe6fa5841659e4f38b84b3a4722e263a Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Mon, 31 Dec 2018 17:15:37 +0800
Subject: [PATCH] drm/lima: add gem prime vmap/vunmap/mmap

Signed-off-by: Qiang Yu <yuq825@gmail.com>
---
 drivers/gpu/drm/lima/lima_drv.c       |  3 +++
 drivers/gpu/drm/lima/lima_gem.c       |  2 +-
 drivers/gpu/drm/lima/lima_gem_prime.c | 47 ++++++++++++++++++++++++++++++++++-
 drivers/gpu/drm/lima/lima_gem_prime.h |  5 +++-
 drivers/gpu/drm/lima/lima_object.h    |  1 +
 5 files changed, 55 insertions(+), 3 deletions(-)

diff --git a/drivers/gpu/drm/lima/lima_drv.c b/drivers/gpu/drm/lima/lima_drv.c
index 4f0060e..5a7fa58 100644
--- a/drivers/gpu/drm/lima/lima_drv.c
+++ b/drivers/gpu/drm/lima/lima_drv.c
@@ -340,6 +340,9 @@ static struct drm_driver lima_drm_driver = {
 	.gem_prime_export   = drm_gem_prime_export,
 	.gem_prime_res_obj  = lima_gem_prime_res_obj,
 	.gem_prime_get_sg_table = lima_gem_prime_get_sg_table,
+	.gem_prime_vmap = lima_gem_prime_vmap,
+	.gem_prime_vunmap = lima_gem_prime_vunmap,
+	.gem_prime_mmap = lima_gem_prime_mmap,
 };
 
 static int lima_pdev_probe(struct platform_device *pdev)
diff --git a/drivers/gpu/drm/lima/lima_gem.c b/drivers/gpu/drm/lima/lima_gem.c
index 0288496..027243c 100644
--- a/drivers/gpu/drm/lima/lima_gem.c
+++ b/drivers/gpu/drm/lima/lima_gem.c
@@ -121,7 +121,7 @@ int lima_gem_mmap(struct file *filp, struct vm_area_struct *vma)
 	if (dev == NULL)
 		return -EINVAL;
 
-	if (!lima_gem_prime_mmap(filp, vma))
+	if (!lima_gem_prime_dma_buf_mmap(filp, vma))
 		return 0;
 
 	return ttm_bo_mmap(filp, vma, &dev->mman.bdev);
diff --git a/drivers/gpu/drm/lima/lima_gem_prime.c b/drivers/gpu/drm/lima/lima_gem_prime.c
index 05c4372..b483b8b 100644
--- a/drivers/gpu/drm/lima/lima_gem_prime.c
+++ b/drivers/gpu/drm/lima/lima_gem_prime.c
@@ -48,7 +48,7 @@ struct sg_table *lima_gem_prime_get_sg_table(struct drm_gem_object *obj)
 	return drm_prime_pages_to_sg(bo->tbo.ttm->pages, npages);
 }
 
-int lima_gem_prime_mmap(struct file *filp, struct vm_area_struct *vma)
+int lima_gem_prime_dma_buf_mmap(struct file *filp, struct vm_area_struct *vma)
 {
 	struct drm_file *priv = filp->private_data;
 	struct drm_device *dev = priv->minor->dev;
@@ -97,3 +97,48 @@ int lima_gem_prime_mmap(struct file *filp, struct vm_area_struct *vma)
 	drm_gem_object_put_unlocked(obj);
 	return ret;
 }
+
+void *lima_gem_prime_vmap(struct drm_gem_object *obj)
+{
+	struct lima_bo *bo = to_lima_bo(obj);
+	int ret;
+
+	ret = ttm_bo_kmap(&bo->tbo, 0, bo->tbo.num_pages, &bo->dma_buf_vmap);
+	if (ret)
+		return ERR_PTR(ret);
+
+	return bo->dma_buf_vmap.virtual;
+}
+
+void lima_gem_prime_vunmap(struct drm_gem_object *obj, void *vaddr)
+{
+	struct lima_bo *bo = to_lima_bo(obj);
+
+	ttm_bo_kunmap(&bo->dma_buf_vmap);
+}
+
+int lima_gem_prime_mmap(struct drm_gem_object *obj, struct vm_area_struct *vma)
+{
+	struct lima_bo *bo = to_lima_bo(obj);
+	struct lima_device *dev = ttm_to_lima_dev(bo->tbo.bdev);
+	int ret;
+
+	if (!vma->vm_file || !dev)
+		return -ENODEV;
+
+	/* Check for valid size. */
+	if (obj->size < vma->vm_end - vma->vm_start)
+		return -EINVAL;
+
+	vma->vm_pgoff += drm_vma_node_offset_addr(&bo->tbo.vma_node) >> PAGE_SHIFT;
+
+	/* prime mmap does not need to check access, so allow here */
+	ret = drm_vma_node_allow(&obj->vma_node, vma->vm_file->private_data);
+	if (ret)
+		return ret;
+
+	ret = ttm_bo_mmap(vma->vm_file, vma, &dev->mman.bdev);
+	drm_vma_node_revoke(&obj->vma_node, vma->vm_file->private_data);
+
+	return ret;
+}
diff --git a/drivers/gpu/drm/lima/lima_gem_prime.h b/drivers/gpu/drm/lima/lima_gem_prime.h
index 31793e7..05ddb59 100644
--- a/drivers/gpu/drm/lima/lima_gem_prime.h
+++ b/drivers/gpu/drm/lima/lima_gem_prime.h
@@ -9,7 +9,10 @@ struct drm_gem_object *lima_gem_prime_import_sg_table(
 	struct sg_table *sgt);
 struct sg_table *lima_gem_prime_get_sg_table(struct drm_gem_object *obj);
 struct reservation_object *lima_gem_prime_res_obj(struct drm_gem_object *obj);
+void *lima_gem_prime_vmap(struct drm_gem_object *obj);
+void lima_gem_prime_vunmap(struct drm_gem_object *obj, void *vaddr);
+int lima_gem_prime_mmap(struct drm_gem_object *obj, struct vm_area_struct *vma);
 
-int lima_gem_prime_mmap(struct file *filp, struct vm_area_struct *vma);
+int lima_gem_prime_dma_buf_mmap(struct file *filp, struct vm_area_struct *vma);
 
 #endif
diff --git a/drivers/gpu/drm/lima/lima_object.h b/drivers/gpu/drm/lima/lima_object.h
index f854a25..54ffcc4 100644
--- a/drivers/gpu/drm/lima/lima_object.h
+++ b/drivers/gpu/drm/lima/lima_object.h
@@ -17,6 +17,7 @@ struct lima_bo {
 	struct ttm_placement placement;
 	struct ttm_buffer_object tbo;
 	struct ttm_bo_kmap_obj kmap;
+	struct ttm_bo_kmap_obj dma_buf_vmap;
 
 	struct list_head va;
 
-- 
2.7.1

