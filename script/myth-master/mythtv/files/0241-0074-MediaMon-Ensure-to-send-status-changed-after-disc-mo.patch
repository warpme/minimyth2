From c89239e52d2bedbf98aadbc345256480f71d45a2 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Sat, 11 Aug 2012 18:10:28 +0200
Subject: [PATCH 074/333] MediaMon: Ensure to send status changed after disc
 mounted

If a USB key disc is inserted then a mount event is never triggered
and the media is never recognized.  If the disk is mounted before
mythfrontend is started or is mounted by an external agent then the
media is recognized.

This patch ensures that whenever a disk is mounted an event is triggered
and also adds some debug log output to show all media transitions.

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
---
 mythtv/libs/libmythbase/mythmedia.cpp |    6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/mythtv/libs/libmythbase/mythmedia.cpp b/mythtv/libs/libmythbase/mythmedia.cpp
index a0b24e8..93c1c29 100644
--- a/mythtv/libs/libmythbase/mythmedia.cpp
+++ b/mythtv/libs/libmythbase/mythmedia.cpp
@@ -159,7 +159,7 @@ bool MythMediaDevice::performMountCmd(bool DoMount)
                                            " find mounted media, but failed?");
                     return false;
                 }
-                m_Status = MEDIASTAT_MOUNTED;
+                setStatus(MEDIASTAT_MOUNTED); // emit statusChanged
                 onDeviceMounted();
                 LOG(VB_GENERAL, LOG_INFO,
                         QString("Detected MediaType ") + MediaTypeString());
@@ -462,6 +462,10 @@ MythMediaStatus MythMediaDevice::setStatus( MythMediaStatus NewStatus,
     // depending on the old and new status.
     if (NewStatus != OldStatus)
     {
+        LOG(VB_MEDIA, LOG_DEBUG,
+            QString("MythMediaDevice::setStatus %1 %2->%3")
+            .arg(getDevicePath()).arg(MediaStatusStrings[OldStatus])
+            .arg(MediaStatusStrings[NewStatus]));
         switch (NewStatus)
         {
             // the disk is not / should not be mounted.
-- 
1.7.9.5

