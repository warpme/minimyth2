From 9dbbd09b87b8be76bbba476ba17a5ef1a86663b1 Mon Sep 17 00:00:00 2001
From: Lawrence Rust <lvr@softsystem.co.uk>
Date: Fri, 24 May 2013 16:14:42 +0100
Subject: [PATCH 35/56] AO: Cache the result of IsPulseAudioRunning

Signed-off-by: Lawrence Rust <lvr@softsystem.co.uk>
Signed-off-by: Jean-Yves Avenard <jyavenard@mythtv.org>
---
 mythtv/libs/libmyth/audio/audiopulsehandler.cpp |   28 +++++++++++++++++++++--
 1 file changed, 26 insertions(+), 2 deletions(-)

diff --git a/mythtv/libs/libmyth/audio/audiopulsehandler.cpp b/mythtv/libs/libmyth/audio/audiopulsehandler.cpp
index 2594ac1..99ca910 100644
--- a/mythtv/libs/libmyth/audio/audiopulsehandler.cpp
+++ b/mythtv/libs/libmyth/audio/audiopulsehandler.cpp
@@ -1,6 +1,7 @@
 #include <QMutexLocker>
 #include <QString>
 #include <QMutex>
+#include <QTime>
 
 #include <unistd.h> // for usleep
 
@@ -52,10 +53,32 @@ bool PulseHandler::Suspend(enum PulseAction action)
         return true;
     }
 
-    // do nothing if PulseAudio is not currently running
-    if (!IsPulseAudioRunning())
+    static int s_iPulseRunning = -1;
+    static QTime s_time;
+    static enum PulseAction s_ePulseAction = PulseAction(-1);
+
+    // Use the last result of IsPulseAudioRunning if within time
+    if (!s_time.isNull() && s_time.elapsed() < 30000)
+    {
+        if (!s_iPulseRunning)
+            return false;
+
+        // If the last action is repeated then do nothing
+        if (action == s_ePulseAction)
+            return true;
+    }
+    // NB IsPulseAudioRunning calls myth_system and can take up to 100mS
+    else if (IsPulseAudioRunning())
+    {
+        s_iPulseRunning = 1;
+        s_time.start();
+    }
+    else
     {
+        // do nothing if PulseAudio is not currently running
         LOG(VB_AUDIO, LOG_INFO, LOC + "PulseAudio not running");
+        s_iPulseRunning = 0;
+        s_time.start();
         return false;
     }
 
@@ -91,6 +114,7 @@ bool PulseHandler::Suspend(enum PulseAction action)
     // disable processing of incoming callbacks in case we delete/recreate our
     // instance due to a termination or other failure
     g_pulseHandlerActive = false;
+    s_ePulseAction = action;
     return result;
 }
 
-- 
1.7.10.2

