From 6b1daf763a239d908bfe72322c09a54cc258e2a6 Mon Sep 17 00:00:00 2001
From: Detlev Casanova <detlev.casanova@collabora.com>
Date: Tue, 15 Jul 2025 08:57:38 -0400
Subject: [PATCH 31/31] wip: update ext controls

---
 .../rockchip/rkvdec/rkvdec-hevc-common.c      | 40 +++++++++++++------
 .../rockchip/rkvdec/rkvdec-hevc-common.h      |  3 +-
 .../media/platform/rockchip/rkvdec/rkvdec.c   |  6 ++-
 include/uapi/linux/v4l2-controls.h            |  4 +-
 4 files changed, 37 insertions(+), 16 deletions(-)

diff --git a/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.c b/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.c
index 0cefec53fc..d81e8cbdf3 100644
--- a/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.c
+++ b/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.c
@@ -206,44 +206,57 @@ void rkvdec_hevc_assemble_hw_scaling_list(struct rkvdec_dev *rkvdec,
 	       sizeof(struct v4l2_ctrl_hevc_scaling_matrix));
 }
 
-void rkvdec_hevc_assemble_hw_rps(struct rkvdec_hevc_run *run, struct rkvdec_rps *rps)
+static void rkvdec_hevc_assemble_hw_lt_rps(struct rkvdec_hevc_run *run, struct rkvdec_rps *rps)
 {
 	const struct v4l2_ctrl_hevc_sps *sps = run->sps;
 
-	memset(rps, 0, sizeof(*rps));
-
-	if (!run->sps_rps_extended)
+	if (!run->ext_sps_lt_rps)
 		return;
 
 	for (int i = 0; i < sps->num_long_term_ref_pics_sps; i++) {
 		rps->refs[i].lt_ref_pic_poc_lsb =
-			run->sps_rps_extended[i].lt_ref_pic_poc_lsb_sps;
+			run->ext_sps_lt_rps[i].lt_ref_pic_poc_lsb_sps;
 		rps->refs[i].used_by_curr_pic_lt_flag =
-			!!(run->sps_rps_extended[i].flags & V4L2_HEVC_EXT_SPS_RPS_FLAG_USED_LT);
+			!!(run->ext_sps_lt_rps[i].flags & V4L2_HEVC_EXT_SPS_LT_RPS_FLAG_USED_LT);
 	}
+}
+
+static void rkvdec_hevc_assemble_hw_st_rps(struct rkvdec_hevc_run *run, struct rkvdec_rps *rps)
+{
+	const struct v4l2_ctrl_hevc_sps *sps = run->sps;
+
+	if (!run->ext_sps_st_rps)
+		return;
 
 	for (int i = 0; i < sps->num_short_term_ref_pic_sets; i++) {
 		int poc = 0;
 		int j = 0;
-		const struct v4l2_ctrl_hevc_ext_sps_rps *set =
-			&run->sps_rps_extended[i];
+		const struct v4l2_ctrl_hevc_ext_sps_st_rps *set =
+			&run->ext_sps_st_rps[i];
 
 		rps->short_term_ref_sets[i].num_negative = set->num_negative_pics;
 		rps->short_term_ref_sets[i].num_positive = set->num_positive_pics;
 
 		for (; j < set->num_negative_pics; j++) {
 			set_ref_poc(&rps->short_term_ref_sets[i], j,
-				    set->delta_poc_s0[j], set->used_by_curr_pic_s0[j]);
+				    set->delta_poc_s0_minus1[j], !!(set->used_by_curr_pic & j));
 		}
 		poc = j;
 
 		for (j = 0; j < set->num_positive_pics; j++) {
 			set_ref_poc(&rps->short_term_ref_sets[i], poc + j,
-				    set->delta_poc_s1[j], set->used_by_curr_pic_s1[j]);
+				    set->delta_poc_s1_minus1[j], !!(set->used_by_curr_pic & (poc + j)));
 		}
 	}
 }
 
+void rkvdec_hevc_assemble_hw_rps(struct rkvdec_hevc_run *run, struct rkvdec_rps *rps)
+{
+	memset(rps, 0, sizeof(*rps));
+	rkvdec_hevc_assemble_hw_lt_rps(run, rps);
+	rkvdec_hevc_assemble_hw_st_rps(run, rps);
+}
+
 struct vb2_buffer *get_ref_buf(struct rkvdec_ctx *ctx,
 			       struct rkvdec_hevc_run *run,
 			       unsigned int dpb_idx)
@@ -323,8 +336,11 @@ void rkvdec_hevc_run_preamble(struct rkvdec_ctx *ctx,
 			      V4L2_CID_STATELESS_HEVC_SCALING_MATRIX);
 	run->scaling_matrix = ctrl ? ctrl->p_cur.p : NULL;
 	ctrl = v4l2_ctrl_find(&ctx->ctrl_hdl,
-			      V4L2_CID_STATELESS_HEVC_EXT_SPS_RPS);
-	run->sps_rps_extended = ctrl ? ctrl->p_cur.p : NULL;
+			      V4L2_CID_STATELESS_HEVC_EXT_SPS_ST_RPS);
+	run->ext_sps_st_rps = ctrl ? ctrl->p_cur.p : NULL;
+	ctrl = v4l2_ctrl_find(&ctx->ctrl_hdl,
+			      V4L2_CID_STATELESS_HEVC_EXT_SPS_LT_RPS);
+	run->ext_sps_lt_rps = ctrl ? ctrl->p_cur.p : NULL;
 
 	rkvdec_run_preamble(ctx, &run->base);
 }
diff --git a/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.h b/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.h
index 94c98da423..5c12336b38 100644
--- a/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.h
+++ b/drivers/media/platform/rockchip/rkvdec/rkvdec-hevc-common.h
@@ -65,7 +65,8 @@ struct rkvdec_hevc_run {
 	const struct v4l2_ctrl_hevc_sps			*sps;
 	const struct v4l2_ctrl_hevc_pps			*pps;
 	const struct v4l2_ctrl_hevc_scaling_matrix	*scaling_matrix;
-	const struct v4l2_ctrl_hevc_ext_sps_rps		*sps_rps_extended;
+	const struct v4l2_ctrl_hevc_ext_sps_st_rps	*ext_sps_st_rps;
+	const struct v4l2_ctrl_hevc_ext_sps_lt_rps	*ext_sps_lt_rps;
 	int						num_slices;
 };
 
diff --git a/drivers/media/platform/rockchip/rkvdec/rkvdec.c b/drivers/media/platform/rockchip/rkvdec/rkvdec.c
index 5d86fb7cdd..87c04893f9 100644
--- a/drivers/media/platform/rockchip/rkvdec/rkvdec.c
+++ b/drivers/media/platform/rockchip/rkvdec/rkvdec.c
@@ -297,7 +297,11 @@ static const struct rkvdec_ctrl_desc rkvdec_hevc_ctrl_descs[] = {
 		.cfg.max = V4L2_MPEG_VIDEO_HEVC_LEVEL_6_1,
 	},
 	{
-		.cfg.id = V4L2_CID_STATELESS_HEVC_EXT_SPS_RPS,
+		.cfg.id = V4L2_CID_STATELESS_HEVC_EXT_SPS_ST_RPS,
+		.cfg.dims = { 65 },
+	},
+	{
+		.cfg.id = V4L2_CID_STATELESS_HEVC_EXT_SPS_LT_RPS,
 		.cfg.dims = { 65 },
 	},
 };
diff --git a/include/uapi/linux/v4l2-controls.h b/include/uapi/linux/v4l2-controls.h
index 40a0b9805e..6c00f144d0 100644
--- a/include/uapi/linux/v4l2-controls.h
+++ b/include/uapi/linux/v4l2-controls.h
@@ -2545,7 +2545,7 @@ struct v4l2_ctrl_hevc_scaling_matrix {
 	__u8	scaling_list_dc_coef_32x32[2];
 };
 
-#define V4L2_HEVC_SHORT_TERM_RPS_FLAG_INTER_REF_PIC_SET_PRED	0x1
+#define V4L2_HEVC_EXT_SPS_ST_RPS_FLAG_INTER_REF_PIC_SET_PRED	0x1
 
 /*
  * struct v4l2_ctrl_hevc_ext_sps_st_rps - HEVC short term RPS parameters
@@ -2584,7 +2584,7 @@ struct v4l2_ctrl_hevc_ext_sps_st_rps {
 	__u8	flags;
 };
 
-#define V4L2_HEVC_LONG_TERM_RPS_RPS_FLAG_USED_LT		0x1
+#define V4L2_HEVC_EXT_SPS_LT_RPS_FLAG_USED_LT		0x1
 
 /*
  * struct v4l2_ctrl_hevc_ext_sps_lt_rps - HEVC long term RPS parameters
-- 
2.46.0

