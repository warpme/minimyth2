Patch from MiniMyth2 project

Developed-by: Piotr Oniszczuk <piotr.oniszczuk@gmail.com>
Signed-off-by: Piotr Oniszczuk <piotr.oniszczuk@gmail.com>



diff --speed-large-files --no-dereference --minimal -Naur linux-6.19-rc8/arch/arm64/boot/dts/allwinner/sun55i-a527-cubie-a5e.dts linux-6.19-rc8/arch/arm64/boot/dts/allwinner/sun55i-a527-cubie-a5e.dts
--- linux-6.19-rc8/arch/arm64/boot/dts/allwinner/sun55i-a527-cubie-a5e.dts	2026-02-01 23:01:13.000000000 +0100
+++ linux-6.19-rc8/arch/arm64/boot/dts/allwinner/sun55i-a527-cubie-a5e.dts	2026-01-30 15:53:44.066687082 +0100
@@ -1,21 +1,32 @@
 // SPDX-License-Identifier: (GPL-2.0-only OR MIT)
-// Copyright (C) 2025 Arm Ltd.
+// Author: piotr.oniszczuk@gmail.com
 
 /dts-v1/;
 
 #include "sun55i-a523.dtsi"
+#include "sun55i-a523-cpu-opp.dtsi"
 
 #include <dt-bindings/gpio/gpio.h>
-#include <dt-bindings/leds/common.h>
+
+#define USE_PCIE 1
 
 / {
 	model = "Radxa Cubie A5E";
 	compatible = "radxa,cubie-a5e", "allwinner,sun55i-a527";
 
 	aliases {
+		mmc0 = &mmc0;
+		mmc1 = &mmc1;
+		mmc2 = &mmc2;
 		ethernet0 = &gmac0;
 		ethernet1 = &gmac1;
 		serial0 = &uart0;
+		pcie = &pcie;
+		combophy = &combophy;
+		gma340_oe = &gma340_oe;
+		gma340_pcie = &gma340_pcie;
+		reg_pcie_3v3 = &reg_pcie_3v3;
+		reg_pcie_1v8 = &reg_pcie_1v8;
 	};
 
 	chosen {
@@ -25,18 +36,16 @@
 	leds {
 		compatible = "gpio-leds";
 
-		power-led {
-			function = LED_FUNCTION_POWER;
-			color = <LED_COLOR_ID_GREEN>;
+		led-0 {
+			label = "radxa:green:power";
 			gpios = <&r_pio 0 4 GPIO_ACTIVE_LOW>; /* PL4 */
-			default-state = "on";
 			linux,default-trigger = "heartbeat";
 		};
 
-		use-led {
-			function = LED_FUNCTION_ACTIVITY;
-			color = <LED_COLOR_ID_BLUE>;
+		led-1 {
+			label = "radxa:blue:user";
 			gpios = <&r_pio 0 5 GPIO_ACTIVE_LOW>; /* PL5 */
+			linux,default-trigger = "disk-activity";
 		};
 	};
 
@@ -64,6 +73,79 @@
 		gpio = <&r_pio 0 8 GPIO_ACTIVE_HIGH>;	/* PL8 */
 		enable-active-high;
 	};
+
+	reg_3v3_wifi: 3v3-wifi {
+		compatible = "regulator-fixed";
+		regulator-name = "3v3-wifi";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		vin-supply = <&reg_vcc5v>;
+		gpio = <&r_pio 0 7 GPIO_ACTIVE_HIGH>; /* PL7 */
+		enable-active-high;
+	};
+
+	reg_pcie_3v3: pcie-3v3 {
+		compatible = "regulator-fixed";
+		regulator-name = "pcie-3v3";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-enable-ramp-delay = <1000>;
+		regulator-always-on;
+		regulator-boot-on;
+		gpio = <&r_pio 0 11 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+	};
+
+	reg_pcie_1v8: pcie-1v8 {
+		compatible = "regulator-fixed";
+		regulator-name = "pcie-1v8";
+		regulator-min-microvolt = <1800000>;
+		regulator-max-microvolt = <1800000>;
+		regulator-enable-ramp-delay = <1000>;
+		regulator-always-on;
+		regulator-boot-on;
+	};
+
+	gma340_oe: gma340-oe {
+		compatible = "regulator-fixed";
+		regulator-name = "gma340-oe";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-always-on;
+		regulator-boot-on;
+		gpio = <&pio 1 7 GPIO_ACTIVE_LOW>;
+	};
+
+#ifdef USE_PCIE
+	gma340_pcie: gma340-pcie {
+		compatible = "regulator-fixed";
+		regulator-name = "gma340-pcie";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-always-on;
+		regulator-boot-on;
+		gpio = <&pio 1 6 GPIO_ACTIVE_HIGH>;
+		enable-active-high;
+	};
+#else
+	gma340_usb3: gma340-usb3 {
+		compatible = "regulator-fixed";
+		regulator-name = "gma340-usb3";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		regulator-always-on;
+		regulator-boot-on;
+		gpio = <&pio 1 6 GPIO_ACTIVE_LOW>;
+	};
+#endif
+};
+
+&cpu0 {
+	cpu-supply = <&reg_dcdc1>;
+};
+
+&cpu4 {
+	cpu-supply = <&reg_dcdc1_323>;
 };
 
 &ehci0 {
@@ -85,22 +167,23 @@
 	status = "okay";
 };
 
+&gpu {
+	mali-supply = <&reg_dcdc2>;
+	status = "okay";
+};
+
 &gmac1 {
 	phy-mode = "rgmii-id";
 	phy-handle = <&ext_rgmii1_phy>;
-	phy-supply = <&reg_cldo4>;
+	phy-supply = <&reg_cldo3>;
 
 	tx-internal-delay-ps = <300>;
 	rx-internal-delay-ps = <400>;
+	use-25m-clk;
 
 	status = "okay";
 };
 
-&gpu {
-	mali-supply = <&reg_dcdc2>;
-	status = "okay";
-};
-
 &mdio0 {
 	ext_rgmii0_phy: ethernet-phy@1 {
 		compatible = "ethernet-phy-ieee802.3-c22";
@@ -128,6 +211,24 @@
 	status = "okay";
 };
 
+&mmc1_pins {
+	drive-strength = <40>;
+};
+
+&mmc1 {
+	max-frequency = <15000000>;
+	bus-width = <4>;
+	non-removable;
+	sd-uhs-sdr104;
+	vmmc-supply = <&reg_3v3_wifi>;
+	vqmmc-supply = <&reg_bldo1>;
+	status = "okay";
+
+	wlan: wifi@1 {
+		reg = <1>;
+	};
+};
+
 &ohci0 {
 	status = "okay";
 };
@@ -207,6 +308,7 @@
 			};
 
 			reg_aldo2: aldo2 {
+				regulator-always-on;
 				regulator-min-microvolt = <1800000>;
 				regulator-max-microvolt = <1800000>;
 				regulator-name = "vcc-pe";
@@ -228,6 +330,7 @@
 			};
 
 			reg_bldo1: bldo1 {
+				regulator-always-on;
 				regulator-min-microvolt = <1800000>;
 				regulator-max-microvolt = <1800000>;
 				regulator-name = "vcc-pg-iowifi";
@@ -241,6 +344,7 @@
 			};
 
 			reg_bldo3: bldo3 {
+				regulator-always-on;
 				regulator-min-microvolt = <3300000>;
 				regulator-max-microvolt = <3300000>;
 				regulator-name = "vcc-mipi-cam";
@@ -251,9 +355,10 @@
 			};
 
 			reg_cldo1: cldo1 {
+				regulator-always-on;
 				regulator-min-microvolt = <1800000>;
 				regulator-max-microvolt = <1800000>;
-				regulator-name = "vcc-pc-and-their-dog";
+				regulator-name = "vcc-pc";
 			};
 
 			reg_cldo2: cldo2 {
@@ -269,11 +374,10 @@
 			};
 
 			reg_cldo4: cldo4 {
+				regulator-always-on;
 				regulator-min-microvolt = <3300000>;
 				regulator-max-microvolt = <3300000>;
 				regulator-name = "vcc-pj-phy";
-				/* enough time for the PHY to fully power on */
-				regulator-enable-ramp-delay = <150000>;
 			};
 
 			reg_cpusldo: cpusldo {
@@ -323,6 +427,9 @@
 			};
 
 			/* DCDC2 is polyphased with DCDC1 */
+			reg_dcdc2_323: dcdc2 {
+				x-powers,force-polyfase-mode;
+			};
 
 			/* RISC-V management core supply */
 			reg_dcdc3_323: dcdc3 {
@@ -381,3 +488,57 @@
 	usb1_vbus-supply = <&reg_usb_vbus>;
 	status = "okay";
 };
+
+&gpu {
+	mali-supply = <&reg_dcdc2>;
+	status = "okay";
+};
+
+/* PCIE and USB Switch */
+&combophy {
+	resets = <&ccu RST_BUS_PCIE_USB3>;
+#ifdef  USE_PCIE
+	phy_use_sel = <0>; /* 0:PCIE; 1:USB3 */
+#else
+	phy_use_sel = <1>; /* 0:PCIE; 1:USB3 */
+#endif
+	status = "okay";
+};
+
+#ifdef  USE_PCIE
+&pcie {
+	reset-gpios = <&pio 7 11 GPIO_ACTIVE_HIGH>;
+	wake-gpios = <&pio 7 12 GPIO_ACTIVE_HIGH>;
+	num-lanes  = <1>;
+	clk-freq-100M;
+	pcie3v3-supply = <&reg_pcie_3v3>;
+	pcie1v8-supply = <&reg_pcie_1v8>;
+	status = "okay";
+};
+#else
+&usbc2 {
+	drvvbus-supply = <&reg_usb_vbus>;
+	wakeup-source;
+	usb_detect_mode = <0x0>;
+	aw,vbus-shared-quirk;
+	status = "okay";
+};
+
+&xhci2 {
+	drvvbus-supply = <&reg_usb_vbus>;
+	dr_mode = "host";
+	status = "okay";
+};
+
+&u2phy {
+	status = "okay";
+};
+#endif
+
+&usbc1 {
+	device_type = "usbc1";
+	usb_regulator_io = "nocare";
+	usb_wakeup_suspend = <1>;
+	wakeup-source;
+	status = "okay";
+};
--

MiniMyth2

