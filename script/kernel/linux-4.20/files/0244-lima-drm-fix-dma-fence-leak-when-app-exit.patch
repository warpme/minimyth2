From 2321dfa7558eb9211730c710f627404bee52bbb2 Mon Sep 17 00:00:00 2001
From: Qiang Yu <yuq825@gmail.com>
Date: Thu, 29 Nov 2018 22:18:43 +0800
Subject: [PATCH 44/46] drm/lima: fix dma fence leak when app exit

Signed-off-by: Qiang Yu <yuq825@gmail.com>
Tested-by: Erico Nunes <nunes.erico@gmail.com>
---
 drivers/gpu/drm/lima/lima_sched.c | 6 +++++-
 1 file changed, 5 insertions(+), 1 deletion(-)

diff --git a/drivers/gpu/drm/lima/lima_sched.c b/drivers/gpu/drm/lima/lima_sched.c
index 154d204..0c6b7c3 100644
--- a/drivers/gpu/drm/lima/lima_sched.c
+++ b/drivers/gpu/drm/lima/lima_sched.c
@@ -187,8 +187,12 @@ void lima_sched_context_fini(struct lima_sched_pipe *pipe,
 
 	mutex_destroy(&context->lock);
 
-	if (context->fences)
+	if (context->fences) {
+		int i;
+		for (i = 0; i < lima_sched_max_tasks; i++)
+			dma_fence_put(context->fences[i]);
 		kfree(context->fences);
+	}
 }
 
 static uint32_t lima_sched_context_add_fence(struct lima_sched_context *context,
-- 
2.7.1

